<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pharmacy Billing & Payment - Final</title>
 
  <!-- Bootstrap + jQuery -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
 
  <style>
    :root{
      --royal-dark: #07245a;
      --royal: #0a3d91;
      --sky: #dff4ff;
      --accent: #5eb7f7;
      --card-border: #c9d8ef;
    }
 
    main { margin-left: 250px; padding: 28px; }
    @media (max-width: 768px) { main { margin-left: 0; padding: 16px; } }
 
    .card { border:1px solid var(--card-border); border-radius:12px; box-shadow: 0 4px 18px rgba(12,40,80,0.04);}
    .card .card-body { padding:18px; }
    h3,h5,h6 { color:#0b3b78; }
    table.table thead th { border-bottom:2px solid #eef3fb; }
    .qty-input { width:80px; }
    .pay-btn { background:var(--accent); color:#fff; border:0; border-radius:8px; padding:8px 16px; }
    .pay-btn:hover { background:var(--royal); color:#fff; }
    .customer-card { background: var(--sky); border:2px solid var(--card-border); padding:16px; border-radius:10px; display:none;}
    .customer-card p { margin-bottom:6px; }
    .history-item { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #f1f6fb; }
    .history-item:last-child{ border-bottom:0; }
 
    .success-card { padding:28px; border-radius:12px; border:2px solid #cfe9d7; box-shadow: 0 8px 24px rgba(50,120,70,0.06); }
    .success-tick { font-size:70px; color:#1aa34a; line-height:1; }
 
    @media print {
      #sidebarContainer, .btn, .nav { display: none !important; }
      main { margin-left:0 !important; }
    }
  </style>
</head>
<body>
  <div id="alertArea" style="position:fixed; top:16px; left:50%; transform:translateX(-50%); z-index:1200;"></div>
  <div id="sidebarContainer"></div>
 
  <script>
    // Load sidebar
    $("#sidebarContainer").load("../Shared/sidebar.html", function(response, status){
      if(status === "error" || $("#sidebarContainer").is(':empty')){
        const fallback = `
          <nav class="sidebar" style="width:240px; position:fixed; top:0; left:0; min-height:100vh;
               background:linear-gradient(180deg, var(--royal-dark), var(--royal)); color:#fff; padding:20px;">
            <div style="font-weight:700; font-size:20px; margin-bottom:12px;">Pharmacy System</div>
            <a href="../Home/dashboard.html" style="display:block; color:#fff; padding:10px 0; text-decoration:none;">Dashboard</a>
            <a href="../Prescription/carted_med.html" style="display:block; color:#fff; padding:10px 0; text-decoration:none;">Cart & Prescription</a>
            <a href="../Medicine/my_order.html" style="display:block; color:#fff; padding:10px 0; text-decoration:none;">My Orders</a>
            <a href="../Payment/billing.html" style="display:block; color:#fff; padding:10px 0; text-decoration:none;">Billing & Payment</a>
            <a href="../Support/customerSupport.html" style="display:block; color:#fff; padding:10px 0; text-decoration:none;">Customer Support</a>
            <a href="../Profile/profile.html" style="display:block; color:#fff; padding:10px 0; text-decoration:none;">User Profile</a>
          </nav>`;
        $("#sidebarContainer").html(fallback);
      } else { $("#sidebarContainer").find('a').css('color','#fff'); }
    });
  </script>
 
  <main>
    <div id="main-content">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Billing & Payment</h3>
        <div>
          <button id="print-page" class="btn btn-outline-primary me-2">Print</button>
          <button id="export-btn" class="btn btn-outline-secondary">Export</button>
        </div>
      </div>
 
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Cart Items</h5>
                <small class="text-muted" id="cart-count">0 items</small>
              </div>
 
              <div class="table-responsive">
                <table class="table align-middle" id="cart-table">
                  <thead>
                    <tr>
                      <th>Medicine</th><th>Qty</th><th>Price (₹)</th><th>Total (₹)</th><th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
 
              <div class="d-flex justify-content-end">
                <button class="btn pay-btn" id="pay-now">Pay</button>
              </div>
            </div>
          </div>
 
          <div class="card p-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <h6 class="me-auto mb-0">Order History</h6>
              </div>
              <div id="order-history" class="mt-2"></div>
            </div>
          </div>
        </div>
 
        <div class="col-lg-4">
          <div class="customer-card mb-3" id="customer-section">
            <h6 class="mb-2">Customer Details</h6>
            <p class="mb-1"><strong id="cust-name">John Doe</strong></p>
            <p class="text-muted" id="cust-address">123, Example Street, City</p>
            <p class="mb-0"><small class="text-muted">Phone: <span id="cust-phone">+91 00000 00000</span></small></p>
          </div>
 
          <div class="card p-3 mb-3">
            <h6>Seller Contact</h6>
            <p class="mb-1"><strong id="seller-name">Reliable Pharmacy</strong></p>
            <p class="text-muted mb-0">Contact: <span id="seller-contact">+91 91234 56789</span></p>
          </div>
 
          <div class="card p-3">
            <h6>Quick Summary</h6>
            <div class="d-flex justify-content-between mt-2"><div>Subtotal</div><div>₹ <span id="summary-sub">0.00</span></div></div>
            <div class="d-flex justify-content-between mt-1"><div>Discount</div><div>- ₹ <span id="summary-dis">0.00</span></div></div>
            <div class="d-flex justify-content-between mt-1"><div>GST</div><div>₹ <span id="summary-gst">0.00</span></div></div>
            <hr>
            <div class="d-flex justify-content-between fw-bold"><div>Total</div><div>₹ <span id="summary-total">0.00</span></div></div>
          </div>
        </div>
      </div>
    </div>
 
    <!-- SUCCESS PAYMENT SECTION WILL BE DYNAMICALLY ADDED AFTER PAYMENT -->
    <div id="success-container"></div>
 
  </main>
 
  <!-- Payment Modal -->
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Confirm Payment</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-2 d-flex justify-content-between"><div>Subtotal</div><div>₹ <span id="modal-sub">0.00</span></div></div>
          <div class="mb-2 d-flex justify-content-between"><div>Discount</div><div>- ₹ <span id="modal-dis">0.00</span></div></div>
          <div class="mb-2 d-flex justify-content-between"><div>GST</div><div>₹ <span id="modal-gst">0.00</span></div></div>
          <hr>
          <div class="mb-3 d-flex justify-content-between fw-bold"><div>Total Payable</div><div>₹ <span id="modal-total">0.00</span></div></div>
 
          <form id="payment-form">
            <div class="row g-2">
              <div class="col-12 col-md-6 mb-2">
                <label for="billing-name" class="form-label">Billing Name</label>
                <input type="text" class="form-control" id="billing-name" required>
              </div>
              <div class="col-12 col-md-6 mb-2">
                <label for="billing-phone" class="form-label">Phone Number</label>
                <input type="text" class="form-control" id="billing-phone" required>
              </div>
              <div class="col-12 mb-2">
                <label for="billing-address" class="form-label">Address</label>
                <textarea class="form-control" id="billing-address" rows="2" required></textarea>
              </div>
              <div class="col-12 mb-2">
                <label for="billing-email" class="form-label">Billing Email</label>
                <input type="email" class="form-control" id="billing-email" placeholder="email@domain.com" required>
              </div>
            </div>
 
            <div class="mb-3">
              <label class="form-label">Payment Method</label>
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="payMethod" id="pm-card" value="Card">
                  <label class="form-check-label" for="pm-card">Card</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="payMethod" id="pm-upi" value="UPI">
                  <label class="form-check-label" for="pm-upi">UPI</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="payMethod" id="pm-net" value="Netbanking">
                  <label class="form-check-label" for="pm-net">Netbanking</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="payMethod" id="pm-cash" value="Cash">
                  <label class="form-check-label" for="pm-cash">Cash</label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn pay-btn" id="confirm-pay">Confirm & Pay</button>
        </div>
      </div>
    </div>
  </div>
 
  <script>
    // -------- DATA --------
    let cart = [
      { id:1, name:'Paracetamol 500mg', qty:1, price:120.00 },
      { id:2, name:'Cough Syrup 100ml', qty:1, price:150.00 },
      { id:3, name:'Vitamin D 60pcs', qty:2, price:250.00 }
    ];
 
    let orderHistory = [
      { id:'ORD1001', date:'2025-11-20', amount:340.00, items:['Paracetamol 500mg'], showAdd:false },
      { id:'ORD1002', date:'2025-11-25', amount:150.00, items:['Cough Syrup 100ml'], showAdd:false },
      { id:'ORD1003', date:'2025-12-09', amount:457.52, items:['Vitamin D 60pcs'], showAdd:false }
    ];
 
    const DISCOUNT_PERCENT = 5;
    const GST_PERCENT = 12;
 
    function currency(x){ return Number(x).toFixed(2); }
 
    function updateCustomerDetails(name, phone, address){
      $('#cust-name').text(name);
      $('#cust-phone').text(phone);
      $('#cust-address').text(address);
      $('#customer-section').show();
    }
 
    function saveCustomerDetails(name, phone, address){
      localStorage.setItem('customer', JSON.stringify({name, phone, address}));
    }
 
    function loadCustomerDetails(){
      const c = JSON.parse(localStorage.getItem('customer'));
      if(c){ updateCustomerDetails(c.name, c.phone, c.address); }
    }
 
    function showAlert(msg, type='success', ms=2200){
      const $a = $(`<div class="alert alert-${type} alert-dismissible fade show" role="alert" style="min-width:300px;">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
      $('#alertArea').append($a); setTimeout(()=>{$a.alert('close');}, ms);
    }
 
    function renderCart(){
      const $tbody = $('#cart-table tbody').empty(); let subtotal=0;
      cart.forEach(item=>{
        const total=item.qty*item.price; subtotal+=total;
        $tbody.append(`<tr data-id="${item.id}"><td>${item.name}</td><td><input class="form-control form-control-sm qty-input" type="number" min="1" value="${item.qty}"></td><td>₹ ${currency(item.price)}</td><td class="item-total">₹ ${currency(total)}</td><td><button class="btn btn-sm btn-outline-danger remove-item">Remove</button></td></tr>`);
      });
      $('#cart-count').text(cart.length+' items');
      updateSummary(subtotal);
    }
 
    function updateSummary(subtotal){
      const discount=(subtotal*DISCOUNT_PERCENT)/100; const gst=((subtotal-discount)*GST_PERCENT)/100; const total=subtotal-discount+gst;
      $('#summary-sub').text(currency(subtotal)); $('#summary-dis').text(currency(discount)); $('#summary-gst').text(currency(gst)); $('#summary-total').text(currency(total));
      $('#modal-sub').text(currency(subtotal)); $('#modal-dis').text(currency(discount)); $('#modal-gst').text(currency(gst)); $('#modal-total').text(currency(total));
    }
 
    function renderOrderHistory(){
      const $wrap=$('#order-history').empty();
      orderHistory.forEach(o=>{
        const addBtn=o.showAdd?'<button class="btn btn-sm btn-outline-success">Add</button>':'';
        $wrap.append(`<div class="history-item"><div><strong>${o.id}</strong> - ₹ ${currency(o.amount)}</div>${addBtn}</div>`);
      });
    }
 
    $(function(){
      loadCustomerDetails(); renderCart(); renderOrderHistory();
 
      $('#cart-table').on('change', '.qty-input', function(){
        const $tr=$(this).closest('tr'); const id=Number($tr.data('id')); const item=cart.find(c=>c.id===id); const newQty=Number($(this).val());
        if(item&&newQty>=1){item.qty=newQty;} renderCart();
      });
 
      $('#cart-table').on('click', '.remove-item', function(){
        const id=Number($(this).closest('tr').data('id')); cart=cart.filter(c=>c.id!==id); renderCart();
      });
 
      $('#pay-now').on('click', function(){
        if(cart.length===0){showAlert('Cart is empty','warning'); return;}
        const modal=new bootstrap.Modal(document.getElementById('paymentModal')); modal.show();
      });
 
      $('#confirm-pay').on('click', function(){
        const total=Number($('#summary-total').text()); const method=$('input[name=payMethod]:checked').val()||'N/A';
        const orderId='ORD'+(1000+orderHistory.length+1);
        orderHistory.push({id:orderId, date:new Date().toISOString().split('T')[0], amount:total, items:cart.map(c=>c.name), showAdd:true});
        renderOrderHistory();
 
        // DYNAMIC SUCCESS SECTION
        const name=$('#billing-name').val(); const phone=$('#billing-phone').val(); const address=$('#billing-address').val();
        updateCustomerDetails(name, phone, address); saveCustomerDetails(name, phone, address);
 
        const $success = $(`
          <div id="success" class="d-flex flex-column text-center mt-5">
            <div class="success-card mx-auto" style="max-width:620px;">
              <div class="success-tick">✔</div>
              <h4 class="mb-2">Payment Successful</h4>
              <p class="text-muted mb-3">Thank you. Your order has been placed and a confirmation email has been sent.</p>
              <div class="text-start">
                <p class="mb-1"><strong>Order ID:</strong> ${orderId}</p>
                <p class="mb-1"><strong>Paid Amount:</strong> ₹ ${currency(total)}</p>
                <p class="mb-1"><strong>Payment Method:</strong> ${method}</p>
              </div>
              <div class="mt-3">
                <a href="#" class="btn btn-outline-primary" id="new-order">Back to Billing</a>
              </div>
            </div>
          </div>`);
        $('#success-container').html($success); $('#main-content').hide();
 
        cart=[]; renderCart(); $('#paymentModal').modal('hide');
 
        // Back to billing
        $('#new-order').on('click', function(e){ e.preventDefault(); $('#success-container').empty(); $('#main-content').show(); });
      });
 
      $('#print-page').on('click', function(){ window.print(); });
    });
  </script>
</body>
</html>